#!/sbin/sh

abi="$(grep -m 1 'ro.product.cpu.abi=' /system/build.prop /default.prop 2>/dev/null | cut -d'=' -f2)"

if [ -z "${abi}" ]; then
    abi=armeabi-v7a
fi

sed "1,/BEGIN_${abi}/d;/END_${abi}/,\$d" "${0}" | base64 -d > /tmp/miniunzip
chmod 755 /tmp/miniunzip

show_help() {
    /tmp/miniunzip
}

# miniunzip does not support extracting multiple files in one command
args=$(getopt -o exvlop:d: -n "${0}" -- "${@}")

if [[ ${?} -ne 0 ]]; then
    show_help
    exit 1
fi

eval set -- "${args}"

args_pre=""
args_post=""
zip_file=""

while true; do
    case "${1}" in
    -e|-x|-v|-l|-o)
        args_pre="${args_pre} ${1}"
        shift
        ;;
    -p)
        args_pre="${args_pre} ${1} ${2}"
        shift 2
        ;;
    -d)
        args_post="${args_post} ${1} ${2}"
        shift 2
        ;;
    --)
        shift
        break
        ;;
    esac
done

if [ "${#}" -eq 0 ]; then
    show_help
    exit 1
fi

zip_file="${1}"
shift

if [ "${#}" -eq 0 ]; then
    /tmp/miniunzip ${args_pre} "${zip_file}" ${args_post}
    exit "${?}"
fi

for f in "${@}"; do
    /tmp/miniunzip ${args_pre} "${zip_file}" "${f}" ${args_post}
    ret="${?}"
    if ! [ "${ret}" -eq 0 ]; then
        exit "${ret}"
    fi
done

exit 0
